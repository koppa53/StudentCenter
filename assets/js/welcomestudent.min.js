

const student_id = sessionStorage.getItem("id"),
token = sessionStorage.getItem("token"),
get_profile_url = "https://softeng.jbtabz.com/student/" + student_id;
const enrollmentID_url = "https://softeng.jbtabz.com/enrollments/"+student_id;
const box1 = document.querySelector('#box1');
const box2 = document.querySelector('#box2');
const box3 = document.querySelector('#box3');
let gradesTable = document.querySelector("#grade");
let schedsTable = document.querySelector("#sched");
var result ;
var timetables = [
    ['', '', '', '', '', '', '', '', '', '', '', '','','','','','','','','','','','','','','','','','','',''],
    ['', '', '', '', '', '', '', '', '', '', '', '','','','','','','','','','','','','','','','','','','',''],
    ['', '', '', '', '', '', '', '', '', '', '', '','','','','','','','','','','','','','','','','','','',''],
    ['', '', '', '', '', '', '', '', '', '', '', '','','','','','','','','','','','','','','','','','','',''],
    ['', '', '', '', '', '', '', '', '', '', '', '','','','','','','','','','','','','','','','','','','',''],
    ['', '', '', '', '', '', '', '', '', '', '', '','','','','','','','','','','','','','','','','','','',''],
    ['', '', '', '', '', '', '', '', '', '', '', '','','','','','','','','','','','','','','','','','','',''],
    ];
//Initialize Day-Frame and timetable setup
var week =  ['Mon', 'Tue', 'Wed', 'Thur', 'Fri','Sat','Sun'];
var highlightWeek = new Date().getDay();
var styles = {
    Gheight: 50,
    leftHandWidth: 80,
    palette: ['#3574ab', '#e08b02']
};

//Initialize Time-Frame
var timetableType = [
[{index: 'AM',name: '7:00'}, 1],
[{index: 'AM',name: '7:30'}, 1],
[{index: 'AM',name: '8:00'}, 1],
[{index: 'AM',name: '8:30'}, 1],
[{index: 'AM',name: '9:00'}, 1],
[{index: 'AM',name: '9:30'}, 1],
[{index: 'AM',name: '10:00'}, 1],
[{index: 'AM',name: '10:30'}, 1],
[{index: 'AM',name: '11:00'}, 1],
[{index: 'AM',name: '11:30'}, 1],
[{index: 'AM',name: '12:00'}, 1],
[{index: 'PM',name: '12:30'}, 1],
[{index: 'PM',name: '1:00'}, 1],
[{index: 'PM',name: '1:30'}, 1],
[{index: 'PM',name: '2:00'}, 1],
[{index: 'PM',name: '2:30'}, 1],
[{index: 'PM',name: '3:00'}, 1],
[{index: 'PM',name: '3:30'}, 1],
[{index: 'PM',name: '4:00'}, 1],
[{index: 'PM',name: '4:30'}, 1],
[{index: 'PM',name: '5:00'}, 1],
[{index: 'PM',name: '5:30'}, 1],
[{index: 'PM',name: '6:00'}, 1],
[{index: 'PM',name: '6:30'}, 1],
[{index: 'PM',name: '7:00'}, 1],
[{index: 'PM',name: '7:30'}, 1],
[{index: 'PM',name: '8:00'}, 1],
[{index: 'PM',name: '8:30'}, 1],
[{index: 'PM',name: '9:00'}, 1],
[{index: 'PM',name: '9:30'}, 1],
[{index: 'PM',name: '10:00'}, 1]
];

var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
var days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

window.onload = function () {
    var today = new Date();
    var date = days[today.getDay()]+", "+months[today.getMonth()]+" "+today.getDate()+", "+today.getFullYear();
    document.getElementById("date").innerHTML = date
    box1.style.boxShadow = "0px 2px 8px 8px rgba(0,0,0,.1)"
    box2.style.boxShadow = "0px 2px 8px 8px rgba(0,0,0,.1)"
    box3.style.boxShadow = "0px 2px 8px 8px rgba(0,0,0,.1)"
    fetchUserName();
    fetchCurrentGrades()
};

async function fetchUserName() {
    const e = await fetch(get_profile_url, { headers: { "X-Session-Token": token } }),
        t = await e.json();
    document.getElementById("welcome").innerHTML = "WELCOME " + t.first_name.toUpperCase() + " !";
}

async function fetchCurrentGrades(){
    const response = await fetch (enrollmentID_url,{
        headers:{
            "X-Session-Token": token
        }
    })
    result = await response.json();
    const grades_url = "https://softeng.jbtabz.com/grades/"+ result[0].id;
    const res = await fetch (grades_url,{
        headers:{
            "X-Session-Token": token
        }
    })
    const grd = await res.json()
    grd.forEach(function(v){
        temp = v.subject_code;
        v.subject_code = v.subject_name;
        v.subject_name = temp; 
        v.grade = parseFloat(v.grade).toFixed(1);
        delete v.subject_unit_lec;
        delete v.subject_unit_lab;
        delete v.subject_id;
        delete v.is_hidden;
        delete v.updated_at});
    const head = { 'Course Code' : '', 'Subject' : '', 'Grades' :''};
    let k = Object.keys(head);
    generateTableHead(gradesTable,k);
    generateGradesTable(gradesTable,grd);
    document.querySelector("#fetch").style.display = "none"
    fetchCurrentSchedule(result)
}

function generateTableHead(table, data) {
    let thead = table.createTHead();
    let row = thead.insertRow();
    for (let key of data) {
        let th = document.createElement("th");
        let text = document.createTextNode(key);
        th.appendChild(text);
        row.appendChild(th);
    }
}

function generateGradesTable(table, data) {
    for (let element of data) {
        let row = table.insertRow();
        row.style.backgroundColor = "#ffffff";
        for (key in element) {
            if(key != "subject_unit_lab" && key!= "subject_unit_lec"){
                let text = ""
                let cell = row.insertCell();
                cell.style.textAlign = "center"
                //Classify Cell for grades status 
                if(element[key]=="NaN"){
                    text = document.createTextNode("TBD");
                }else if(element[key]=="-1"){
                    text = document.createTextNode("INC");
                }else if(element[key]=="-2"){
                    text = document.createTextNode("DRP");
                }else{
                    text = document.createTextNode(element[key]);
                    if(element[key]=="5.0") {
                        row.style.backgroundColor = "#DE0F3F";
                        row.style.color = "white";
                    }
                }
                cell.appendChild(text);
            }
        }
    }
}

async function fetchCurrentSchedule(result){
    const schedule_url = "https://softeng.jbtabz.com/course_schedule_contents/"+ result[0].course_schedule_id;
        const response = await fetch(schedule_url,{
            headers:{
                "X-Session-Token": token
            }
        });
    const data = await response.json();
    data.forEach(function(v){
        var profname = v.professor_first_name+" "+v.professor_middle_name+" "+v.professor_last_name;
        var x=0;
        var time = [0,0];
        delete v.id;
        delete v.course_schedule_id; 
        delete v.schedule_id;
        delete v.professor_id;
        delete v.subject_id;
        delete v.created_at;
        for(var y =0; y<=v.schedule_days.length; y++){
            if(v.schedule_days[y]=="mon"){
                time = plot_table_time(v.schedule_time_start,v.schedule_time_duration);
                for(i=time[0],x=1;x<=time[1];i++,x++){
                    timetables[0][i] = v.subject_name+"\n\n"+"Room: \n"+v.schedule_room+ "\n\nProfessor: "+profname;
                }
            }
            if(v.schedule_days[y]=="tues"){
                time = plot_table_time(v.schedule_time_start,v.schedule_time_duration);
                for(i=time[0],x=1;x<=time[1];i++,x++){
                    timetables[1][i] = v.subject_name+"\n\n"+"Room: \n"+v.schedule_room+ "\n\nProfessor: "+profname;
                }
            }
            if(v.schedule_days[y]=="wed"){
                time = plot_table_time(v.schedule_time_start,v.schedule_time_duration);
                for(i=time[0],x=1;x<=time[1];i++,x++){
                    timetables[2][i] = v.subject_name+"\n\n"+"Room: \n"+v.schedule_room+ "\n\nProfessor: "+profname;
                }
            }
            if(v.schedule_days[y]=="thur"){
                time = plot_table_time(v.schedule_time_start,v.schedule_time_duration);
                for(i=time[0],x=1;x<=time[1];i++,x++){
                    timetables[3][i] = v.subject_name+"\n\n"+"Room: \n"+v.schedule_room+ "\n\nProfessor: "+profname;
                }
            }
            if(v.schedule_days[y]=="fri"){
                time = plot_table_time(v.schedule_time_start,v.schedule_time_duration);
                for(i=time[0],x=1;x<=time[1];i++,x++){
                    timetables[4][i] = v.subject_name+"\n\n"+"Room: \n"+v.schedule_room+ "\n\nProfessor: "+profname;
                }
            }
            if(v.schedule_days[y]=="sat"){
                time = plot_table_time(v.schedule_time_start,v.schedule_time_duration);
                for(i=time[0],x=1;x<=time[1];i++,x++){
                    timetables[5][i] = v.subject_name+"\n\n"+"Room: \n"+v.schedule_room+ "\n\nProfessor: "+profname;
                }
            }
            if(v.schedule_days[y]=="sun"){
                time = plot_table_time(v.schedule_time_start,v.schedule_time_duration);
                for(i=time[0],x=1;x<=time[1];i++,x++){
                    timetables[6][i] = v.subject_name+"\n\n"+"Room: \n"+v.schedule_room+ "\n\nProfessor: "+profname;
                }
            }
        }
    });
    createTable()
    document.querySelector("#fetch2").style.display = "none"
}

function createTable(){
    var Timetable = new Timetables({
        el: '#coursesTable',
        timetables: timetables,
        week: week,
        timetableType: timetableType,
        styles: styles,
        gridOnClick: function (e) {
            if (e.name!="") alert(e.name)
        },
    });
}

function plot_table_time(time,duration){
    var i = 0;
    var d = 0;
    var t=[];
    if(time == "07:00:00"){
        t[0] = 0;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "07:30:00"){
        t[0] = 1;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "08:00:00"){
        t[0] = 2;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "08:30:00"){
        t[0] = 3;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "09:00:00"){
        t[0] = 4;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "09:30:00"){
        t[0] = 5;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "10:00:00"){
        t[0] = 6;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "10:30:00"){
        t[0] = 7;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "11:00:00"){
        t[0] = 8;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "11:30:00"){
        t[0] = 9;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "12:00:00"){
        t[0] = 10;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "12:30:00"){
        t[0] = 11;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "13:00:00"){
        t[0] = 12;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "13:30:00"){
        t[0] = 13;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "14:00:00"){
        t[0] = 14;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "14:30:00"){
        t[0] = 15;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "15:00:00"){
        t[0] = 16;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "15:30:00"){
        t[0] = 17;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "16:00:00"){
        t[0] = 18;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "16:30:00"){
        t[0] = 19;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "17:00:00"){
        t[0] = 20;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "17:30:00"){
        t[0] = 21;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=3
        }
        t[1] = d
        return t
    }
    if(time == "18:00:00"){
        t[0] = 22;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=3
        }
        t[1] = d
        return t
    }
    if(time == "18:30:00"){
        t[0] = 23;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "19:00:00"){
        t[0] = 24;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "19:30:00"){
        t[0] = 25;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "20:00:00"){
        t[0] = 26;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "20:30:00"){
        t[0] = 27;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "21:00:00"){
        t[0] = 27;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "21:30:00"){
        t[0] = 27;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
    if(time == "22:00:00"){
        t[0] = 27;
        for(i=1;i<=duration.hours;i++){
            d+=2
        }
        if(Object.keys(duration).length > 1){
            d+=1
        }
        t[1] = d
        return t
    }
}
